<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Laro ng Lahi</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Custom Scripts -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth.js"></script>

    <link rel="stylesheet" href="assets/css/login.css">
    <style>
        .back-link {
            display: block;
            margin-top: 20px;
            color: #E0FBFC;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
            color: #E9C46A;
        }
    </style>
</head>

<body>
    <!-- Floating particles -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="container">
        <div class="logo">
            <img src="assets/startmenu/screen_title.png" alt="Laro ng Lahi">
        </div>

        <div id="error-message" class="error"></div>
        <div id="success-message" class="error"
            style="background: rgba(46, 204, 113, 0.9); border-color: #2ecc71; display: none; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center;">
        </div>

        <div id="loading" style="color:white; font-size:18px; display:none;">Verifying Link...</div>

        <form id="resetPasswordForm" style="display:none;">
            <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password" required minlength="6">
            </div>

            <div class="form-group">
                <label for="confirm_password">Confirm New Password</label>
                <input type="password" id="confirm_password" required minlength="6">
            </div>

            <button type="submit" class="btn btn-login" style="width: 100%;" id="submitBtn">
                RESET PASSWORD
            </button>
        </form>

        <div id="loginLinkContainer" style="display:none; margin-top:20px;">
            <a href="login.html" class="btn btn-login" style="width: 100%; display:block; box-sizing:border-box;">GO TO
                LOGIN</a>
            <button id="openAppBtn" class="btn btn-guest" style="width: 100%; margin-top: 15px;">OPEN IN APP</button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Get the action code from the URL (oobCode)
            const urlParams = new URLSearchParams(window.location.search);
            const actionCode = urlParams.get('oobCode');

            if (actionCode) {
                // Try to launch the app directly if we have a code
                // This allows "Deep Linking" behavior
                const deepLink = `laronglahi://reset-password?oobCode=${actionCode}`;

                // Optional: Attempt to open app automatically
                // window.location.href = deepLink;

                console.log("Deep link target:", deepLink);
            }

            const form = document.getElementById('resetPasswordForm');
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('error-message');
            const successMsg = document.getElementById('success-message');
            const loginLinkContainer = document.getElementById('loginLinkContainer');
            const openAppBtn = document.getElementById('openAppBtn');

            if (openAppBtn) {
                openAppBtn.addEventListener('click', () => {
                    window.location.href = 'laronglahi://open';
                });
            }

            if (!actionCode) {
                errorMsg.textContent = "Invalid or missing reset code. Please request a new password reset link.";
                errorMsg.style.display = 'block';
                return;
            }

            // Verify Code
            loading.style.display = 'block';
            console.log("Verifying code...");
            const verifyResult = await Auth.verifyPasswordResetCode(actionCode);
            loading.style.display = 'none';

            if (verifyResult.success) {
                // Code is valid, show form
                form.style.display = 'block';
            } else {
                // Invalid code
                errorMsg.textContent = verifyResult.message || "Invalid or expired reset link.";
                errorMsg.style.display = 'block';
                return;
            }

            // Handle Form Submit
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const newPass = document.getElementById('new_password').value;
                const confirmPass = document.getElementById('confirm_password').value;

                if (newPass !== confirmPass) {
                    errorMsg.textContent = "Passwords do not match.";
                    errorMsg.style.display = 'block';
                    return;
                }

                errorMsg.style.display = 'none';
                const btn = document.getElementById('submitBtn');
                btn.disabled = true;
                btn.textContent = "RESETTING...";

                const resetResult = await Auth.confirmPasswordReset(actionCode, newPass);

                if (resetResult.success) {
                    form.style.display = 'none';
                    successMsg.textContent = resetResult.message;
                    successMsg.style.display = 'block';
                    loginLinkContainer.style.display = 'block';
                } else {
                    errorMsg.textContent = resetResult.message;
                    errorMsg.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = "RESET PASSWORD";
                }
            });
        });
    </script>
</body>

</html>